# [WIP] Api Specification (JSON API interpretation)

Это спецификация о том, как клиент должен запрашивать выборку или изменение ресурсов и как сервер должен отвечать на эти запросы.

Объект JSON **ДОЛЖЕН** находиться в корне каждого запроса и ответа JSON API, содержащего данные. Этот объект определяет "верхний уровень" документа.

Документ **ДОЛЖЕН** содержать следующие поля верхнего уровня:

- `data` - "первичные данные" документа, обязательно при успешном запросе
- `error` - объект ошибок, обязательно при наличии ошибок

Документ **МОЖЕТ** содержать технические поля такие как:

- `apiVersion` - содержит строковое значения, указывающий на текущую версию `api`.
- `method` - содержит название метода, вызвавшего операцию.
- `params` - содержит параметры запроса.
- ...etc

## Первичные данные (data)

**Первичные данные** - это представление ресурса или совокупности ресурсов, на которые направлен запрос.

Первичные данные **ДОЛЖНЫ** быть объектом, содержащим информацию о ресурсе:

```json5
// GET /project/:id
{
  data: {
    title: "Some title",
    description: "...",
  },
}
```

При запросе списка элементов, элементы представляются в виде массива в ключе `items`

```json5
// GET /projects
{
  data: {
    items: [...],
  },
}
```

## Объект Ошибок (error)

При возникновении ошибки на верхнем уровне **ДОЛЖЕН** присутствовать объект`error` с полями:

- `message` - общее обьяснение причины по которой произошла ошибка, поле **ДОЛЖНО** присутствовать всегда
- `code` - код ошибки, например: 400 (Bad Request), 401 (Unauthorized), and 404 (Not Found), поле **ДОЛЖНО** присутствовать всегда
- `errors` - массив ошибок, **МОЖЕТ** отсутствовать
- `errors[].index` - индекс исходно ресурса в массиве переданных для обновления или создания, **МОЖЕТ** отсутствовать в случае обработки объекта ресурса
- `errors[].field` - имя поля ошибки в модели данных, для вложенных полей - путь к полю.
- `errors[].message` - общее обьяснение причины по которой произошла ошибка

Пример ошибки авторизации пользователя:

```json5
// request POST /auth HTTP/1.1
{
  data: {
    name: "",
    password: "",
  },
}
```

```json5
// response
{
  error: {
    message: "check if the fields are correct",
    code: 400,
    errors: [
      {
        field: "name",
        message: "field is required"
      },
      {
        field: "password",
        message: "field is required"
      }
    ]
  }
}
```

Пример ошибки массового обновления пользователей:

```json5
// request
{
  data: {
    items: [
      {
        id: 1,
        name: "John Stanislovas Alphonse Vincent O'Connor",
        type: "",
        age: 1,
      },
      {
        id: 2,
        name: "Sara Connor",
        type: "human",
        age: "35",
      },
      {
        id: 3,
        name: "Sara Connor",
        type: "human",
        age: "",
        abrakadbra: true
      }
    ]
  }
}
```

```json5
// response
{
  error: {
    message: "unable to update multiple users",
    code: 400,
    errors: [
      {
        index: 0,
        field: "type",
        message: "field is required"
      },
      {
        index: 0,
        field: "name",
        message: "limited to 30 characters"
      },
      {
        index: 0,
        field: "age",
        message: "minimum age 16"
      },
      {
        index: 2,
        field: "name",
        message: "already exists"
      },
      {
        index: 2,
        field: "age",
        message: "field is required"
      }
    ],
  }
}
```

## Пагинация и сортировка

Сервер **МОЖЕТ** ограничить количество ресурсов, возвращаемых в ответ, подмножеством ("страницами"). Информация доступна в объекте `data`.

- `totalPages` - всего страниц
- `totalItems` - всего элементов

Для того что бы перейти на следующую страницу клиент должен отправить запрос с параметрами `?page=1&pageSize=10`.

Сортировка на сервере используется по умолчанию, если клиенту потребовалось её изменить, нужно передать дополнительный параметр `sort`, значением которого будет строка состоящая из 2-х частей разделённых двоеточием, 1 часть - имя ключа, по значению которого будет происходить сортировка, 2 часть - направление `asc` (ascending - "по возрастанию") иди `desc` (descending - "по убыванию"). Например, `sort=name:asc`, это означает сортировка по значению ключа `name` с направлением "по возрастанию".

В случае сортировки по нескольким ключам, передаются дополнительные параметры по той же схеме, пример `sort[]=name:asc&sort[]=createAt:desc`

Пример:

```
// request
GET /people?page=1&pageSize=10&sort=asc:name HTTP/1.1
```

```json5
// response
{
  data: {
    items: [
      {
        id: "1",
        name: "Alex"
      },
      {
        id: "2",
        name: "Barbara"
      }
      // ...
    ],
    totalPages: 8,
    totalItems: 82
  }
}
```

## Запросы на обновление и создание ресурсов

POST и PUT запросы **ДОЛЖНЫ** отправлять сообщение - либо JsonDataMsg, если данные запроса в формате json, либо MultiFormDataMsg, если запрос содержит form-data. Данное сообщение должно содержать список команд, в которых должны быть сами данные и тип команды, который хранится в константах (APP_CMD).
